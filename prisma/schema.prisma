// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum PostStatus {
  DRAFT
  PUBLISHED
  HIDDEN
}

enum ReportStatus {
  PENDING
  REVIEWED
  RESOLVED
}

enum ReportType {
  SPAM
  PLAGIARISM
  INAPPROPRIATE
}

// 직종 카테고리
enum Profession {
  DEVELOPER        // 개발자
  DESIGNER         // 디자이너 (UI/UX, 그래픽 등)
  PM               // 프로덕트 매니저
  MARKETER         // 마케터
  DATA_ANALYST     // 데이터 분석가
  CONTENT_CREATOR  // 콘텐츠 크리에이터
  WRITER           // 작가/카피라이터
  PHOTOGRAPHER     // 사진작가
  VIDEO_CREATOR    // 영상 제작자
  MUSICIAN         // 음악가/작곡가
  PLANNER          // 기획자
  RESEARCHER       // 연구원
  CONSULTANT       // 컨설턴트
  EDUCATOR         // 교육자
  OTHER            // 기타
}

// 프로젝트 카테고리
enum ProjectCategory {
  WEB_APP          // 웹 애플리케이션
  MOBILE_APP       // 모바일 앱
  DESIGN           // 디자인 작업물
  BRANDING         // 브랜딩/아이덴티티
  MARKETING        // 마케팅 캠페인
  VIDEO            // 영상 콘텐츠
  PHOTOGRAPHY      // 사진 작업물
  MUSIC            // 음악/오디오
  WRITING          // 글/콘텐츠
  RESEARCH         // 연구/논문
  DATA_ANALYSIS    // 데이터 분석
  CASE_STUDY       // 케이스 스터디
  PRESENTATION     // 프레젠테이션
  GAME             // 게임
  HARDWARE         // 하드웨어/IoT
  OTHER            // 기타
}

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  password          String
  role              UserRole  @default(USER)
  emailVerified     Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  profile           Profile?
  posts             Post[]
  comments          Comment[]
  likes             Like[]
  bookmarks         Bookmark[]
  notifications     Notification[]
  reports           Report[]
  refreshTokens     RefreshToken[]
  followers         Follow[]  @relation("Following")  // Users who follow this user
  following         Follow[]  @relation("Followers")  // Users this user follows
  mentionsSent      Mention[] @relation("MentionAuthor")
  mentionsReceived  Mention[] @relation("MentionTarget")

  @@index([email])
}

model Profile {
  id                String      @id @default(uuid())
  userId            String      @unique
  username          String      @unique  // Unique username for mentions (@username)
  name              String
  title             String?     // 직함/역할 (예: 프론트엔드 개발자)
  avatar            String?
  bio               String?
  location          String?     // 위치 (예: 서울, 대한민국)
  profession        Profession  @default(OTHER)  // 주 직종
  secondaryProfession Profession?               // 부 직종 (옵션)
  skills            String[]    // 범용 스킬/도구 (Figma, Excel, Premiere 등)
  techStack         String[]    // 기술 스택 (개발자용, 하위 호환성)
  githubUrl         String?
  websiteUrl        String?
  linkedinUrl       String?
  behanceUrl        String?     // 디자이너용
  dribbbleUrl       String?     // 디자이너용
  instagramUrl      String?     // 크리에이터용
  youtubeUrl        String?     // 영상 크리에이터용
  twitterUrl        String?     // 소셜 미디어
  notionUrl         String?     // 노션 포트폴리오
  yearsOfExperience Int?        // 경력 연수
  isOpenToWork      Boolean     @default(false)  // 구직 중 여부
  isOpenToCollaborate Boolean   @default(true)   // 협업 제안 받기
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  contributions     ProjectContributor[]  // 참여한 프로젝트들

  @@index([userId])
  @@index([username])
  @@index([profession])
  @@index([isOpenToWork])
}

model Post {
  id                String          @id @default(uuid())
  authorId          String
  title             String
  summary           String?
  content           String          // Rich text or markdown
  coverImage        String?
  media             String[]        // Array of media URLs (images/videos)
  category          ProjectCategory @default(OTHER)  // 프로젝트 카테고리
  skills            String[]        // 범용 스킬/도구 사용 (Figma, Python 등)
  techStack         String[]        // 기술 스택 (하위 호환성)
  repositoryUrl     String?         // 코드 저장소
  demoUrl           String?         // 데모/라이브 링크
  behanceUrl        String?         // Behance 프로젝트 링크
  figmaUrl          String?         // Figma 파일 링크
  youtubeUrl        String?         // YouTube 영상 링크
  externalUrl       String?         // 기타 외부 링크
  status            PostStatus      @default(DRAFT)
  viewCount         Int             @default(0)
  isEditorPick      Boolean         @default(false)
  isFeatured        Boolean         @default(false)  // 메인 피처드
  isTeamProject     Boolean         @default(false)  // 팀 프로젝트 여부
  projectStartDate  DateTime?       // 프로젝트 시작일
  projectEndDate    DateTime?       // 프로젝트 종료일
  publishedAt       DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  author            User            @relation(fields: [authorId], references: [id], onDelete: Cascade)
  contributors      ProjectContributor[]  // 프로젝트 협업자
  comments          Comment[]
  likes             Like[]
  bookmarks         Bookmark[]
  reports           Report[]
  mentions          Mention[]

  @@index([authorId])
  @@index([status])
  @@index([category])
  @@index([publishedAt])
  @@index([isEditorPick])
  @@index([isFeatured])
  @@index([techStack])
  @@index([skills])
}

model Comment {
  id                String    @id @default(uuid())
  postId            String
  authorId          String
  parentId          String?   // For nested comments (replies)
  content           String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  post              Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  author            User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent            Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies           Comment[] @relation("CommentReplies")
  mentions          Mention[]

  @@index([postId])
  @@index([authorId])
  @@index([parentId])
}

model Like {
  id                String    @id @default(uuid())
  postId            String
  userId            String
  createdAt         DateTime  @default(now())
  
  post              Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model Bookmark {
  id                String    @id @default(uuid())
  postId            String
  userId            String
  createdAt         DateTime  @default(now())
  
  post              Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model Notification {
  id                String    @id @default(uuid())
  userId            String
  type              String    // 'like', 'comment', 'bookmark'
  title             String
  message           String
  isRead            Boolean   @default(false)
  relatedPostId     String?
  relatedUserId     String?
  createdAt         DateTime  @default(now())
  
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model Report {
  id                String        @id @default(uuid())
  postId            String
  reporterId        String
  type              ReportType
  reason            String
  status            ReportStatus  @default(PENDING)
  reviewNote        String?
  adminNote         String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  post              Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  reporter          User          @relation(fields: [reporterId], references: [id], onDelete: Cascade)
  
  @@index([postId])
  @@index([reporterId])
  @@index([status])
}

model RefreshToken {
  id         String   @id @default(uuid())
  userId     String
  tokenHash  String
  revoked    Boolean  @default(false)
  revokedAt  DateTime?
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

// Follow relationship for follower/following system
model Follow {
  id          String   @id @default(uuid())
  followerId  String   // The user who is following
  followingId String   // The user being followed
  createdAt   DateTime @default(now())

  follower    User     @relation("Followers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// Mention tracking for @username mentions in posts and comments
model Mention {
  id              String    @id @default(uuid())
  authorId        String    // User who created the mention
  mentionedUserId String    // User who was mentioned (@username)
  postId          String?   // If mention is in a post
  commentId       String?   // If mention is in a comment
  createdAt       DateTime  @default(now())

  author          User      @relation("MentionAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  mentionedUser   User      @relation("MentionTarget", fields: [mentionedUserId], references: [id], onDelete: Cascade)
  post            Post?     @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment         Comment?  @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([mentionedUserId])
  @@index([postId])
  @@index([commentId])
}

// 프로젝트 협업자 (팀 프로젝트에서 역할 표시)
model ProjectContributor {
  id              String      @id @default(uuid())
  postId          String      // 프로젝트 포스트
  profileId       String      // 협업자 프로필
  role            String      // 역할 (예: "UI 디자인", "백엔드 개발", "PM")
  profession      Profession  // 협업자의 직종
  contribution    String?     // 기여 내용 설명
  isVerified      Boolean     @default(false)  // 협업자가 승인했는지
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  post            Post        @relation(fields: [postId], references: [id], onDelete: Cascade)
  profile         Profile     @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([postId, profileId])  // 한 프로젝트에 같은 사람 중복 방지
  @@index([postId])
  @@index([profileId])
  @@index([profession])
}

// 직종별 추천 스킬 목록 (관리자가 관리)
model SkillSuggestion {
  id          String      @id @default(uuid())
  profession  Profession  // 해당 직종
  skillName   String      // 스킬 이름
  category    String?     // 스킬 카테고리 (예: "디자인 도구", "프로그래밍 언어")
  isPopular   Boolean     @default(false)  // 인기 스킬 여부
  createdAt   DateTime    @default(now())

  @@unique([profession, skillName])
  @@index([profession])
  @@index([isPopular])
}

// 협업 요청/제안
model CollaborationRequest {
  id              String      @id @default(uuid())
  senderId        String      // 보낸 사람 (User ID)
  receiverId      String      // 받는 사람 (User ID)
  postId          String?     // 관련 프로젝트 (옵션)
  title           String      // 제안 제목
  message         String      // 제안 내용
  proposedRole    String?     // 제안하는 역할
  status          CollaborationStatus @default(PENDING)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([senderId])
  @@index([receiverId])
  @@index([status])
}

enum CollaborationStatus {
  PENDING
  ACCEPTED
  DECLINED
  CANCELLED
}

// 스킬 추천/보증 시스템
model SkillEndorsement {
  id              String      @id @default(uuid())
  endorserId      String      // 추천하는 사람 (User ID)
  endorseeId      String      // 추천받는 사람 (User ID)
  skill           String      // 추천하는 스킬
  comment         String?     // 추천 코멘트
  relationship    String?     // 관계 (동료, 협업자, 클라이언트 등)
  createdAt       DateTime    @default(now())

  @@unique([endorserId, endorseeId, skill])  // 같은 스킬 중복 추천 방지
  @@index([endorserId])
  @@index([endorseeId])
  @@index([skill])
}

// 프로필 추천서
model ProfileRecommendation {
  id              String      @id @default(uuid())
  authorId        String      // 작성자 (User ID)
  recipientId     String      // 받는 사람 (User ID)
  content         String      // 추천 내용
  relationship    String      // 관계 (팀원, 멘토, 클라이언트 등)
  workPeriod      String?     // 함께 일한 기간
  projectTitle    String?     // 관련 프로젝트
  isPublic        Boolean     @default(true)  // 공개 여부
  isVerified      Boolean     @default(false) // 받는 사람이 승인했는지
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@unique([authorId, recipientId])  // 한 사람당 한 개의 추천서
  @@index([authorId])
  @@index([recipientId])
  @@index([isPublic])
}

// GitHub 연동 정보
model GitHubIntegration {
  id              String      @id @default(uuid())
  userId          String      @unique
  githubUsername  String
  accessToken     String?     // 암호화 저장
  refreshToken    String?
  lastSyncAt      DateTime?
  autoSync        Boolean     @default(false)  // 자동 동기화 여부
  syncSettings    Json?       // 동기화 설정 (어떤 레포 가져올지 등)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([userId])
  @@index([githubUsername])
}

// 프로젝트 통계 (시각화용)
model PostAnalytics {
  id              String      @id @default(uuid())
  postId          String      @unique
  dailyViews      Json        @default("[]")  // [{date: "2024-01-01", count: 10}]
  weeklyViews     Json        @default("[]")
  monthlyViews    Json        @default("[]")
  referralSources Json        @default("[]")  // 유입 경로
  peakViewDate    DateTime?
  avgTimeOnPage   Int?        // 평균 체류 시간 (초)
  bounceRate      Float?      // 이탈률
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([postId])
}
